<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookmark Analyzer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 1rem;
      line-height: 1.4;
      color: #333;
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }

    h2 {
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }

    .upload-area {
      border: 2px dashed #ccc;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
      border-radius: 8px;
      background: #f9f9f9;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #666;
      background: #f0f0f0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-card {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #007acc;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Bar Chart Styles */
    .chart-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .chart-label {
      width: 50px;
      text-align: right;
      padding-right: 10px;
      color: #666;
    }

    .chart-bar-container {
      flex-grow: 1;
      background: #eee;
      height: 20px;
      border-radius: 3px;
      overflow: hidden;
    }

    .chart-bar {
      height: 100%;
      background: #007acc;
      transition: width 0.5s ease;
    }

    .chart-value {
      width: 50px;
      padding-left: 10px;
      font-size: 0.8rem;
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th,
    td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f2f2f2;
    }

    .domain-col {
      font-family: monospace;
    }

    #results {
      display: none;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .controls input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }

    .controls button {
      padding: 0.5rem 1rem;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .controls button:hover {
      background: #005999;
    }

    .dashboard-row {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .dashboard-col {
      flex: 1;
      min-width: 300px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    .bookmarks-list {
      margin-top: 1rem;
      border-top: 1px solid #eee;
    }

    .bookmark-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 0.9rem;
    }

    .bookmark-item a {
      color: #007acc;
      text-decoration: none;
      font-weight: 500;
    }

    .bookmark-item a:hover {
      text-decoration: underline;
    }

    .bookmark-meta {
      color: #666;
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
  </style>
</head>

<body>

  <h1>Bookmark Analyzer</h1>

  <div class="upload-area" id="dropZone">
    <p>Drag & drop your <strong>favorites_...html</strong> file here</p>
    <p>or</p>
    <input type="file" id="fileInput" accept=".html">
  </div>

  <div id="controls" class="controls" style="display: none;">
    <input type="text" id="searchInput" placeholder="Search by title, URL, or folder...">
    <button id="exportBtn">Export JSON</button>
  </div>

  <div id="results">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">Total Bookmarks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="duplicateCount">0</div>
        <div class="stat-label">Duplicates</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="domainCount">0</div>
        <div class="stat-label">Unique Domains</div>
      </div>
    </div>

    <div class="dashboard-row">
      <div class="dashboard-col">
        <h2>Activity by Year</h2>
        <div id="yearChart"></div>
      </div>

      <div class="dashboard-col">
        <h2>Top 20 Domains</h2>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Domain</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody id="topDomains"></tbody>
        </table>
      </div>
    </div>

    <h2>Timeline Extremes</h2>
    <p><strong>Oldest:</strong> <span id="oldestBookmark"></span></p>
    <p><strong>Newest:</strong> <span id="newestBookmark"></span></p>

    <h2>Search Results <span id="resultCount" style="font-weight:normal; font-size: 0.9em; color:#666;"></span></h2>
    <div id="bookmarksList" class="bookmarks-list"></div>
  </div>

  <script>
    const fileInput = document.getElementById( 'fileInput' );
    const dropZone = document.getElementById( 'dropZone' );
    const results = document.getElementById( 'results' );

    // Handle File Selection
    fileInput.addEventListener( 'change', handleFile );

    // Handle Drag & Drop
    dropZone.addEventListener( 'dragover', ( e ) => { e.preventDefault(); dropZone.style.borderColor = '#007acc'; } );
    dropZone.addEventListener( 'dragleave', ( e ) => { e.preventDefault(); dropZone.style.borderColor = '#ccc'; } );
    dropZone.addEventListener( 'drop', ( e ) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ccc';
      if ( e.dataTransfer.files.length ) processFile( e.dataTransfer.files[ 0 ] );
    } );

    function handleFile ( e ) {
      if ( e.target.files.length ) processFile( e.target.files[ 0 ] );
    }

    function processFile ( file ) {
      const reader = new FileReader();
      reader.onload = ( e ) => analyzeBookmarks( e.target.result );
      reader.readAsText( file );
    }

    let allBookmarks = [];

    function analyzeBookmarks ( html ) {
      const parser = new DOMParser();
      const doc = parser.parseFromString( html, "text/html" );
      const links = doc.querySelectorAll( 'a' );

      if ( links.length === 0 ) {
        alert( "No bookmarks found! Make sure it's a valid Netscape Bookmark HTML file." );
        return;
      }

      allBookmarks = Array.from( links ).map( a => {
        const dateStr = a.getAttribute( 'add_date' );
        const date = dateStr ? new Date( parseInt( dateStr ) * 1000 ) : new Date( 0 );

        // Extract folder path
        let path = [];
        let current = a;
        while ( current.parentElement ) {
          if ( current.tagName === 'DL' ) {
            const header = current.previousElementSibling;
            if ( header && ( /^H[1-6]$/ ).test( header.tagName ) ) {
              path.unshift( header.textContent.trim() );
            }
          }
          current = current.parentElement;
        }

        return {
          url: a.href,
          title: a.textContent.trim() || a.href,
          date: date,
          pathArray: path,
          pathString: path.join( ' > ' ) || 'Uncategorized'
        };
      } );

      document.getElementById( 'controls' ).style.display = 'flex';
      renderStats( allBookmarks );
    }

    function renderStats ( bookmarks ) {
      // 1. Basic Stats
      document.getElementById( 'totalCount' ).textContent = bookmarks.length.toLocaleString();

      // 2. Duplicates
      const urlCounts = {};
      bookmarks.forEach( b => urlCounts[ b.url ] = ( urlCounts[ b.url ] || 0 ) + 1 );
      const duplicates = Object.values( urlCounts ).filter( c => c > 1 ).length;
      document.getElementById( 'duplicateCount' ).textContent = duplicates.toLocaleString();

      // 3. Domains
      const domains = {};
      bookmarks.forEach( b => {
        try {
          let hostname = new URL( b.url ).hostname.replace( /^www\./, '' );
          if ( hostname ) domains[ hostname ] = ( domains[ hostname ] || 0 ) + 1;
        } catch ( e ) { }
      } );
      document.getElementById( 'domainCount' ).textContent = Object.keys( domains ).length.toLocaleString();

      // Render Top Domains
      const sortedDomains = Object.entries( domains ).sort( ( a, b ) => b[ 1 ] - a[ 1 ] ).slice( 0, 20 );
      const domainTable = document.getElementById( 'topDomains' );
      domainTable.innerHTML = sortedDomains.map( ( d, i ) => `
                <tr>
                    <td>${ i + 1 }</td>
                    <td class="domain-col"><a href="#" class="domain-link">${ d[ 0 ] }</a></td>
                    <td>${ d[ 1 ] }</td>
                </tr>
            `).join( '' );

      // 4. Timeline (Years)
      const byYear = {};
      bookmarks.forEach( b => {
        const year = b.date.getFullYear();
        if ( !isNaN( year ) && year > 1970 ) byYear[ year ] = ( byYear[ year ] || 0 ) + 1;
      } );

      const years = Object.keys( byYear ).sort();
      const maxCount = Math.max( ...Object.values( byYear ) );
      const chartContainer = document.getElementById( 'yearChart' );

      chartContainer.innerHTML = years.map( year => {
        const count = byYear[ year ];
        const percentage = ( count / maxCount ) * 100;
        return `
                    <div class="chart-row">
                        <div class="chart-label">${ year }</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${ percentage }%"></div>
                        </div>
                        <div class="chart-value">${ count }</div>
                    </div>
                `;
      } ).join( '' );

      // 5. Extremes
      if ( bookmarks.length > 0 ) {
        const sortedByDate = [ ...bookmarks ].filter( b => b.date.getFullYear() > 1970 ).sort( ( a, b ) => a.date - b.date );
        if ( sortedByDate.length > 0 ) {
          const oldest = sortedByDate[ 0 ];
          const newest = sortedByDate[ sortedByDate.length - 1 ];

          document.getElementById( 'oldestBookmark' ).innerHTML = `${ oldest.date.toLocaleDateString() } - <a href="${ oldest.url }" target="_blank">${ oldest.title }</a>`;
          document.getElementById( 'newestBookmark' ).innerHTML = `${ newest.date.toLocaleDateString() } - <a href="${ newest.url }" target="_blank">${ newest.title }</a>`;
        } else {
          document.getElementById( 'oldestBookmark' ).textContent = "N/A";
          document.getElementById( 'newestBookmark' ).textContent = "N/A";
        }
      }

      // 6. Render List (Limited to 100 for performance)
      const listContainer = document.getElementById( 'bookmarksList' );
      const countSpan = document.getElementById( 'resultCount' );
      const displayLimit = 100;

      countSpan.textContent = `(${ bookmarks.length.toLocaleString() })`;

      if ( bookmarks.length > 0 ) {
        const displayList = bookmarks.slice( 0, displayLimit );
        listContainer.innerHTML = displayList.map( b => `
          <div class="bookmark-item">
            <div><a href="${ b.url }" target="_blank">${ b.title }</a></div>
            <div class="bookmark-meta">
              ${ b.date.toLocaleDateString() } â€¢ ${ b.pathString }
            </div>
          </div>
        ` ).join( '' );

        if ( bookmarks.length > displayLimit ) {
          listContainer.innerHTML += `<div style="padding:1rem; text-align:center; color:#666; font-style:italic;">
            ...and ${ ( bookmarks.length - displayLimit ).toLocaleString() } more. Refine your search to see specific items.
          </div>`;
        }
      } else {
        listContainer.innerHTML = '<div style="padding:1rem; color:#666;">No bookmarks found matching your criteria.</div>';
      }

      results.style.display = 'block';
    }

    // Search Listener
    document.getElementById( 'searchInput' ).addEventListener( 'input', ( e ) => {
      const term = e.target.value.toLowerCase();
      const filtered = allBookmarks.filter( b =>
        b.title.toLowerCase().includes( term ) ||
        b.url.toLowerCase().includes( term ) ||
        b.pathString.toLowerCase().includes( term )
      );
      renderStats( filtered );
    } );

    // Export Listener
    document.getElementById( 'exportBtn' ).addEventListener( 'click', () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent( JSON.stringify( allBookmarks, null, 2 ) );
      const downloadAnchorNode = document.createElement( 'a' );
      downloadAnchorNode.setAttribute( "href", dataStr );
      downloadAnchorNode.setAttribute( "download", "bookmarks_export.json" );
      document.body.appendChild( downloadAnchorNode );
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    } );

    // Domain Click Listener
    document.getElementById( 'topDomains' ).addEventListener( 'click', ( e ) => {
      if ( e.target.classList.contains( 'domain-link' ) ) {
        e.preventDefault();
        const searchInput = document.getElementById( 'searchInput' );
        searchInput.value = e.target.textContent;
        searchInput.dispatchEvent( new Event( 'input' ) );
      }
    } );
  </script>
</body>

</html>